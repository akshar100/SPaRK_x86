default:	all


############################################################################
#                     Defining Variables
############################################################################

VERSION		= 2.0
RELEASE		= 1 
RELVER		= $(VERSION)-$(RELEASE)



#
# Directory where SA-RTL Sources are installed
#
RTL_DIR = $(shell pwd)

#
# Directory to Built Object files
#

HOSTARCH := i386

BUILD_DIR = $(RTL_DIR)/build
OBJ_DIR   = $(BUILD_DIR)/objs
LIB_DIR   = $(BUILD_DIR)/libs
IMAGE_DIR = $(BUILD_DIR)

#
# Include Special Architecture Rules
#
ARCH		= $(HOSTARCH)
RTL_ARCH = i386
TARGET_NAME = Guest0S3-$(RELVER)

#
# Include Directories
#
INCLUDE_DIRS = -I$(RTL_DIR)/include/dietlibc -I$(RTL_DIR)/include 
HPATH =     $(RTL_DIR)/include        # Needed by mkdep

#
# Libraries
#
STATIC_LIBS += --static $(LIB_DIR)/libstdio.a
STATIC_LIBS += --static $(LIB_DIR)/libstrings.a
STATIC_LIBS += --static $(LIB_DIR)/libTLSF.a
STATIC_LIBS += --static $(LIB_DIR)/liberrno.a
STATIC_LIBS += --static $(LIB_DIR)/libmem.a
STATIC_LIBS += --static $(LIB_DIR)/libis.a
STATIC_LIBS += --static $(LIB_DIR)/librand.a
STATIC_LIBS += --static $(LIB_DIR)/libmath.a

WARNING_FLAGS = -Wno-uninitialized 

CFLAGS += $(WARNING_FLAGS) -O2 -D__KERNEL__ -nostdinc -fno-builtin $(INCLUDE_DIRS)

ifeq ($(CONFIG_RTL_GDBAGENT),y)
CFLAGS += -g
else
CFLAGS += -fomit-frame-pointer
endif

CC		= ${CROSS_COMPILE}gcc
HOSTCC		= gcc
LD		= ${CROSS_COMPILE}ld


#
# Define Modules to be Compiled
#

#MODULE_DIRS = main
MODULE_DIRS = init
#MODULE_DIRS += drivers
#ifeq ($(CONFIG_RTL_GDBAGENT),y)
#MODULE_DIRS += gdbagent
#endif
#MODULE_DIRS += posixio
#MODULE_DIRS += tracer
#MODULE_DIRS += ipc
MODULE_DIRS += schedulers
MODULE_DIRS += itc
MODULE_DIRS += tasks
MODULE_DIRS += dietlibc
MODULE_DIRS += arch/$(RTL_ARCH)/kernel
MODULE_DIRS += TLSF
MODULE_DIRS += arch/$(RTL_ARCH)/boot

.EXPORT_ALL_VARIABLES:

all: symlinks modules  
	@echo
	@echo 'Image stored in $(IMAGE_DIR)'

symlinks: dummy
	rm -f include/arch
	ln -s arch-$(RTL_ARCH) include/arch

modules: rtl.mk dummy
	@mkdir -p modules
	@set -e;
	@for i in $(MODULE_DIRS); do \
	   $(MAKE) -C $$i; \
	done;


#########################################################################
#        File rtl.mk in all Makefiles 
#########################################################################


rtl.mk: dummy 
	@echo "#Automatically generated by RTLinux Makefile"  > rtl.mk;
	@echo  RTL_DIR = $(RTL_DIR) >>rtl.mk
	@echo  $(INCLUDE_COMMAND) >> rtl.mk;
	@echo  CFLAGS = $(CFLAGS) >> rtl.mk;
	@echo  ARCH = $(ARCH) >> rtl.mk;
	@echo  CC = $(CC) >> rtl.mk;
	@echo  BUILD_DIR = $(BUILD_DIR) >> rtl.mk;
	@echo  OBJ_DIR   = $(OBJ_DIR) >> rtl.mk;
	@echo  LIB_DIR   = $(LIB_DIR) >> rtl.mk;
	@echo  IMAGE_DIR = $(BUILD_DIR) >> rtl.mk


#########################################################################
#        CLEAN project 
#########################################################################

clean:  dummy symlinks 
	@set -e; \
	for i in $(MODULE_DIRS); do \
	   $(MAKE) -C  $$i clean ; \
	done
	@rm -f $(OBJ_DIR)/*
	@rm -f $(LIB_DIR)/*
	@rm -f rtl.mk 
	@rm -f $(BUILD_DIR)/$(TARGET_NAME)

.PHONY: dummy
