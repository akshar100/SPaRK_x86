default:	all


############################################################################
#                     Defining Variables
############################################################################

VERSION		= 0.9
RELEASE		= 1 
RELVER		= $(VERSION)-$(RELEASE)



#
# Directory where SA-RTL Sources are installed
#
RTL_DIR = $(shell pwd)

#
# Directory to Built Object files
#

HOSTARCH := i386

BUILD_DIR = $(RTL_DIR)/build
OBJ_DIR   = $(BUILD_DIR)/objs
LIB_DIR   = $(BUILD_DIR)/libs
IMAGE_DIR = $(BUILD_DIR)

#
# Include Special Architecture Rules
#
ARCH		= $(HOSTARCH)
RTL_ARCH = i386
TARGET_NAME = spark-i386-$(RELVER)

TOPDIR    = $(RTL_DIR)
GUESTOS1  = $(TOPDIR)/guestOSes/GuestOS1
GUESTOS2  = $(TOPDIR)/guestOSes/GuestOS2
GUESTOS3  = $(TOPDIR)/guestOSes/GuestOS3

#
# Include Directories
#
INCLUDE_DIRS = -I$(RTL_DIR)/include/dietlibc -I$(RTL_DIR)/include 
HPATH =     $(RTL_DIR)/include        # Needed by mkdep

#
# Libraries
STATIC_LIBS += --static $(LIB_DIR)/libstdio.a
STATIC_LIBS += --static $(LIB_DIR)/libstrings.a
STATIC_LIBS += --static $(LIB_DIR)/libTLSF.a
STATIC_LIBS += --static $(LIB_DIR)/liberrno.a
STATIC_LIBS += --static $(LIB_DIR)/libmem.a
STATIC_LIBS += --static $(LIB_DIR)/libis.a
STATIC_LIBS += --static $(LIB_DIR)/librand.a
STATIC_LIBS += --static $(LIB_DIR)/libmath.a

WARNING_FLAGS = -Wno-uninitialized 

CFLAGS += $(WARNING_FLAGS) -O2 -D__KERNEL__ -nostdinc -fno-builtin $(INCLUDE_DIRS)

CFLAGS += -fomit-frame-pointer
CFLAGS += -fno-stack-protector

CC		= ${CROSS_COMPILE}gcc
HOSTCC		= gcc
LD		= ${CROSS_COMPILE}ld


#
# Define Modules to be Compiled
#

MODULE_DIRS = main
MODULE_DIRS += init
MODULE_DIRS += drivers
MODULE_DIRS += posixio
MODULE_DIRS += schedulers
MODULE_DIRS += utility
MODULE_DIRS += dietlibc
MODULE_DIRS += arch/$(RTL_ARCH)/kernel
MODULE_DIRS += TLSF
MODULE_DIRS += arch/$(RTL_ARCH)/boot

BOOT_DIR += arch/$(RTL_ARCH)/boot

.EXPORT_ALL_VARIABLES:

all: symlinks modules  
	@echo
#	@echo 'Image stored in $(IMAGE_DIR)'

symlinks: dummy
	rm -f include/arch
	ln -s arch-$(RTL_ARCH) include/arch

modules: rtl.mk dummy
	@mkdir -p modules
	@set -e;
	@for i in $(MODULE_DIRS); do \
	   $(MAKE) -C $$i; \
	done;

# To merge the GOS images with SParK image
# This creates the final imsage to be installed
image:
	cp $(BOOT_DIR)/head.out .
	cp $(BOOT_DIR)/sched.output .
	$(BOOT_DIR)/tools/attach 2 $(BOOT_DIR)/rtvic.out $(GUESTOS1) $(GUESTOS2) $(GUESTOS3) > SparkImage
	$(BOOT_DIR)/tools/build -b $(BOOT_DIR)/bbootsect $(BOOT_DIR)/bsetup  SparkImage > bzImage
	cp -f bzImage $(IMAGE_DIR)/$(TARGET_NAME)
	@rm -f head.out 
	@rm -f sched.output 
	@rm -f SparkImage 
	@rm -f bzImage
	@echo
	@echo 'Image stored in $(IMAGE_DIR)'


#########################################################################
#        File rtl.mk in all Makefiles 
#########################################################################


rtl.mk: dummy 
	@echo "#Automatically generated by RTLinux Makefile"  > rtl.mk;
	@echo  RTL_DIR = $(RTL_DIR) >>rtl.mk
	@echo  $(INCLUDE_COMMAND) >> rtl.mk;
	@echo  CFLAGS = $(CFLAGS) >> rtl.mk;
	@echo  ARCH = $(ARCH) >> rtl.mk;
	@echo  CC = $(CC) >> rtl.mk;
	@echo  BUILD_DIR = $(BUILD_DIR) >> rtl.mk;
	@echo  OBJ_DIR   = $(OBJ_DIR) >> rtl.mk;
	@echo  LIB_DIR   = $(LIB_DIR) >> rtl.mk;
	@echo  IMAGE_DIR = $(BUILD_DIR) >> rtl.mk


#########################################################################
#        CLEAN project 
#########################################################################

clean:  dummy symlinks 
	@set -e; \
	for i in $(MODULE_DIRS); do \
	   $(MAKE) -C  $$i clean ; \
	done
	@rm -f $(OBJ_DIR)/*
	@rm -f $(LIB_DIR)/*
	@rm -f rtl.mk 
	@rm -f $(BUILD_DIR)/$(TARGET_NAME)

.PHONY: dummy
